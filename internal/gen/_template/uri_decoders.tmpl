{{- define "uri_decoders" }}
{{- template "header" $ }}

{{- range $t, $_ := $.URITypes }}
{{- if eq $t.Kind "struct" }}
func (v *{{ $t.Go }}) decodeURI(d uri.Decoder) error {
    if v == nil {
        return fmt.Errorf("unable to decode {{ $t.Go }} to nil")
    }
    return d.DecodeFields(func(name string, d uri.Decoder) error {
        switch name {
        {{- range $f := $t.Fields }}
        {{- if $f.Spec }}
        case "{{ $f.Spec.Name }}":
            {{- template "decode_uri" dict
                "type" $f.Type
                "var" (sprintf "v.%s" $f.Name)
            }}
        {{- end }}
        {{- end }}
        default:
            return fmt.Errorf("unexpected field '%s'", name)
        }
    })
}

{{- end }}
{{- end }}

{{- end }}

{{- define "decode_uri" }}
{{- $t := index . "type" }}
{{- $var := index . "var" }}
{{- if eq $t.Kind "primitive" }}
    s, err := d.DecodeValue()
    if err != nil {
        return err
    }

    c, err := conv.{{ $t.FromString }}(s)
    if err != nil {
        return err
    }

    {{ $var }} = c
    return nil
{{- else if eq $t.Kind "enum" }}
    s, err := d.DecodeValue()
    if err != nil {
        return err
    }

    c, err := conv.{{ $t.FromString }}(s)
    if err != nil {
        return err
    }

    {{ $var }} = {{ $t.Go }}(c)
    return nil
{{- else if eq $t.Kind "array" }}
    return d.DecodeArray(func(d uri.Decoder) error {
        {{- $tmpVar := pascalMP (sprintf "%sItem" $var ) }}
        var {{ $tmpVar }} {{ $t.Item.Go }}
        if err := func() error {
            {{- template "decode_uri" dict
                "type" $t.Item
                "var" $tmpVar
            }}
        }(); err != nil {
            return err
        }
        {{ $var }} = append({{ $var }}, {{ $tmpVar }})
        return nil
    })
{{- else if eq $t.Kind "alias" }}
    {{- $tmpVar := pascalMP (sprintf "%sUnderlying" $var ) }}
    var {{ $tmpVar }} {{ $t.AliasTo.Go }}
    if err := func() error {
        {{- template "decode_uri" dict
            "type" $t.AliasTo
            "var" $tmpVar
        }}
    }(); err != nil {
        return err
    }
    {{ $var }}.wrap({{ $tmpVar }})
    return nil
{{- else if eq $t.Kind "generic" }}
    {{- $tmpVar := pascalMP (sprintf "%sValue" $var ) }}
    var {{ $tmpVar }} {{ $t.GenericOf.Go }}
    if err := func() error {
        {{- template "decode_uri" dict
            "type" $t.GenericOf
            "var" $tmpVar
        }}
    }(); err != nil {
        return err
    }
    {{ $var }}.SetTo({{ $tmpVar }})
    return nil
{{- else if eq $t.Kind "pointer" }}
    {{- $tmpVar := pascalMP (sprintf "%sValue" $var ) }}
    var {{ $tmpVar }} {{ $t.PointerTo.Go }}
    if err := func() error {
        {{- template "decode_uri" dict
            "type" $t.PointerTo
            "var" $tmpVar
        }}
    }(); err != nil {
        return err
    }
    {{ $var }} = &{{ $tmpVar }}
    return nil
{{- else if eq $t.Kind "struct" }}
    return {{ $var }}.decodeURI(d)
{{- else if eq $t.Kind "sum" }}
    // sum not supported
    return nil
{{- else }}
Unexpected kind {{ $t.Kind }}
{{- end }}
{{- end }}