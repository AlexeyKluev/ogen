{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}
{{- define "uri_encoders" }}
{{- template "header" $ }}

{{- range $t, $_ := $.URITypes }}
{{- if $t.IsStruct }}
func (v {{ $t.Go }}) encodeURI(e uri.Encoder) error {
	{{- range $f := $t.Fields }}
	{{- if $f.Spec }}
		if err := e.EncodeField("{{ $f.Spec.Name }}", func(e uri.Encoder) error {
			{{- template "encode_uri" elem $f.Type (printf "v.%s" $f.Name) }}
		}); err != nil {
			return errors.Wrap(err, `field {{ $f.Spec.Name }}`)
		}
	{{- end }}
	{{- end }}
	return nil
}

{{- end }}
{{- end }}
{{- end }}

{{- define "encode_uri" }}
{{- /*gotype: github.com/ogen-go/ogen/internal/gen.Elem*/ -}}
{{- $t := $.Type }}
{{- $var := $.Var }}
{{- if $t.IsPrimitive }}
	return e.EncodeValue(conv.{{ $t.ToString }}({{ $var }}))
{{- else if $t.IsEnum }}
	return e.EncodeValue(conv.{{ $t.ToString }}({{ $t.Primitive.String }}({{ $var }})))
{{- else if $t.IsArray  }}
	return e.EncodeArray(func(e uri.Encoder) error {
		for i, item := range {{ $var }} {
			if err := func() error {
				{{- template "encode_uri" elem $t.Item "item" }}
			}(); err != nil {
				return errors.Wrapf(err, "[%d]", i)
			}
		}
		return nil
	})
{{- else if $t.IsAlias }}
	if unwrapped := {{ $t.AliasTo.Go }}({{ $var }}); true {
		{{- template "encode_uri" elem $t.AliasTo "unwrapped" }}
	}
	return nil
{{- else if $t.IsGeneric }}
	if val, ok := {{ $var }}.Get(); ok {
		{{- template "encode_uri" elem $t.GenericOf "val" }}
	}
	return nil
{{- else if $t.IsPointer }}
	if v := {{ $var }}; v != nil {
		{{- template "encode_uri" elem $t.PointerTo "(*v)" }}
	}
	return nil
{{- else if $t.IsStruct }}
	return {{ $var }}.encodeURI(e)
{{- else if $t.IsSum }}
	switch t := {{ $var }}.Type; t {
	{{- range $of := $t.SumOf }}
	case {{ $of.Name }}{{ $t.Name }}:
		{{- template "encode_uri" elem $of (printf "%s.%s" $var $of.Name) }}
	{{- end }}
	default:
		panic(fmt.Sprintf("unexpected type: %T", t))
	}
{{- else }}
{{ errorf "unexpected kind %s" $t.Kind }}
{{- end }}
{{- end }}
