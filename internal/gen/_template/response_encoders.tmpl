{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}

{{ define "response_encoders" }}
{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $m := $.Methods }}{{/* Range over all methods */}}

func encode{{ $m.Name }}Response(response {{ $m.ResponseType.Type }}, w http.ResponseWriter) error {
    {{- $schemasLength := len $m.ListResponseSchemas }}
    {{- if eq $schemasLength 1 }}

    {{- range $info := $m.ListResponseSchemas }}
        {{- template "respond" $info }}
    {{- end }}

    {{- else }}
    switch response := response.(type) {
    {{- range $info := $m.ListResponseSchemas }}
    case *{{ $info.Schema.Name }}:
        {{- template "respond" $info }}
    {{- end }}
    default:
        return fmt.Errorf("{{ $m.RawPath}}: unexpected response type: %T", response)
    }
    {{- end }}
}


{{- end }}{{/* Range over all methods */}}
{{ end }}

{{ define "respond" }}
{{- /*gotype: github.com/ogen-go/ogen/internal/ast.ResponseInfo*/ -}}
{{- if not $.NoContent }}{{- /* Set content-type */}}
w.Header().Set("Content-Type", "{{ $.ContentType }}")
{{- end }}{{- /* Set content-type */}}

{{- if $.Default }}{{- /* Set status code */}}
w.WriteHeader(response.StatusCode)
{{- else }}
w.WriteHeader({{ $.StatusCode }})
{{- end }}{{- /* Set status code */}}

{{- if $.NoContent }}{{- /* Encode content */}}
return nil
{{- else if eq $.ContentType "application/json" }}
j := json.NewStream(w)
more := json.NewMore(j)
defer more.Reset()
{{ template "json_value" resp_elem $ }}
if err := j.Flush(); err != nil {
    return err
}
return nil
{{- else }}
return fmt.Errorf("{{ $.ContentType }} encoder not implemented")
{{- end }}{{- /* Encode content */ -}}
{{ end }}
