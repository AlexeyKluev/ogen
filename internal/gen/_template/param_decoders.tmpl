{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}

{{ define "param_decoders" }}
{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $m := $.Methods }}{{/* Range over methods */}}
{{ if $m.Parameters }}{{/* Check parameters existence */}}

func decode{{ $m.Name }}Params(r *http.Request) ({{ $m.Name }}Params, error) {
	var params {{ $m.Name }}Params
	{{- range $p := $m.Parameters }}
	// Decode param '{{ $p.SourceName }}' located in '{{ $p.In }}'.
	if err := func() error {
		{{- if eq $p.In "Query" }}
		values, ok := r.URL.Query()["{{ $p.SourceName }}"]
		if !ok {
			{{- if $p.Required }}
			return fmt.Errorf("query parameter '{{ $p.SourceName}}' not specified")
			{{- else }}
			return nil
			{{- end }}
		}

		d := uri.NewQueryDecoder(uri.QueryDecoderConfig{
			Values: values,
			Style: uri.QueryStyle{{ pascalMP $p.Style }},
			Explode: {{ if $p.Explode }}true{{ else }}false{{ end }},
		})

		{{ template "decode_param" $p.Schema }}
		params.{{ $p.Name }} = {{ $p.Schema.Type }}(v)
		return nil
		{{- else if eq $p.In "Path" }}
		param := chi.URLParam(r, "{{ $p.SourceName }}")
		if len(param) == 0 {
			{{- if $p.Required }}
			return fmt.Errorf("path parameter '{{ $p.SourceName}}' not specified")
			{{- else }}
			return nil
			{{- end }}
		}

		d := uri.NewPathDecoder(uri.PathDecoderConfig{
			Param: "{{ $p.SourceName}}",
			Value: param,
			Style: uri.PathStyle{{ pascalMP $p.Style }},
			Explode: {{ if $p.Explode }}true{{ else }}false{{ end }},
		})

		{{ template "decode_param" $p.Schema }}
		params.{{ $p.Name }} = {{ $p.Schema.Type }}(v)
		return nil
		{{- else if eq $p.In "Header" }}

		{{- if eq $p.Schema.Kind "array" }}
		param := r.Header.Values("{{ $p.SourceName }}")
		{{- else if eq $p.Schema.Kind "alias" }}
			{{- if eq $p.Schema.AliasTo.Kind "array" }}
			param := r.Header.Values("{{ $p.SourceName }}")
			{{- else }}
			param := r.Header.Get("{{ $p.SourceName }}")
			{{- end }}
		{{- else }}
		param := r.Header.Get("{{ $p.SourceName }}")
		{{- end }}

		if len(param) == 0 {
			{{- if $p.Required }}
			return fmt.Errorf("header parameter '{{ $p.SourceName}}' not specified")
			{{- else }}
			return nil
			{{- end }}
		}
		
		v, err := {{ template "parse_from_string" $p.Schema.Type }}(param)
		if err != nil {
			return fmt.Errorf("parse {{ $p.In.Lower }} param '{{ $p.SourceName }}': %w", err)
		}

		params.{{ $p.Name }} = {{ $p.Schema.Type }}(v)
		return nil
		{{- else if eq $p.In "Cookie" }}
		c, err := r.Cookie("{{ $p.SourceName }}")
		if err != nil {
			return fmt.Errorf("get cookie '{{ $p.SourceName }}': %w", err)
		}

		param := c.Value
		if len(param) == 0 {
			{{- if $p.Required }}
			return fmt.Errorf("cookie parameter '{{ $p.SourceName}}' not specified")
			{{- else }}
			return nil
			{{- end }}
		}

		v, err := {{ template "parse_from_string" $p.Schema.Type }}(param)
		if err != nil {
			return fmt.Errorf("parse {{ $p.In.Lower }} param '{{ $p.SourceName }}': %w", err)
		}

		params.{{ $p.Name }} = {{ $p.Schema.Type }}(v)
		return nil
		{{- else }}
		unsupported parameter location: {{ $p.In }}
		{{- end }}
	}(); err != nil {
		return params, err
	}
	{{- end }}
	return params, nil
}

{{- end }}{{/* Check parameters existence */}}
{{- end }}{{/* Range over methods */}}
{{ end }}

{{ define "decode_param" }}
{{- if or (eq $.Kind "primitive") (eq $.Kind "enum") }}
	{{- if eq $.Primitive "string" }}v, err := d.DecodeString()
	{{- else if eq $.Primitive "int64" }}v, err := d.DecodeInt64()
	{{- else if eq $.Primitive "int32" }}v, err := d.DecodeInt32()
	{{- else if eq $.Primitive "int" }}v, err := d.DecodeInt()
	{{- else if eq $.Primitive "float64" }}v, err := d.DecodeFloat64()
	{{- else if eq $.Primitive "float32" }}v, err := d.DecodeFloat32()
	{{- else if eq $.Primitive "bool" }}v, err := d.DecodeBool()
	{{- else if eq $.Primitive "time.Time" }}
	vv, err := d.DecodeString(); 
	if err != nil {
		return err
	}

	v, err := time.Parse(vv, time.RFC3339)
	{{- else }} unsupported primitive {{ $.Primitive }}
	{{- end }}
	if err != nil {
		return err
	}
{{- else if eq $.Kind "array" }}
	{{- if eq $.Item.Kind "primitive" }}
		{{- $primitive := $.Item.Primitive }}
		{{- if eq $primitive "string" }}v, err := d.DecodeStringArray()
		{{- else if eq $primitive "int64" }}v, err := d.DecodeInt64Array()
		{{- else if eq $primitive "int32" }}v, err := d.DecodeInt32Array()
		{{- else if eq $primitive "int" }}v, err := d.DecodeIntArray()
		{{- else if eq $primitive "float64" }}v, err := d.DecodeFloat64Array()
		{{- else if eq $primitive "float32" }}v, err := d.DecodeFloat32Array()
		{{- else if eq $primitive "bool" }}v, err := d.DecodeBoolArray()
		{{- else if eq $primitive "time.Time" }}
		vv, err := d.DecodeString(); 
		if err != nil {
			return err
		}

		v, err := time.Parse(vv, time.RFC3339)
		{{- else }}unsupported array item primitive {{ $.Item.Primitive }}
		{{- end }}
		if err != nil {
			return err
		}
	{{- else }}
	unsupported array item kind {{ $.Item.Kind }}
	{{- end }}
{{- else }}
unsupported kind {{ $.Kind }}
{{- end }}
{{- end }}
