{{- /*gotype: github.com/ogen-go/ogen/internal/gen.Elem*/ -}}
{{- define "enc_json_start" -}}
{{- if $.More  -}}
more.More()
{{- end -}}
{{- if $.Tag.JSON  }}
j.WriteObjectField("{{ $.Tag.JSON }}")
{{- end }}
{{- end -}}

{{- define "enc_json_array_elems" }}
more.Down()
j.WriteArrayStart()
for _, elem := range {{ $.Var }} {
  {{- template "enc_json" array_elem $.Type.Item }}
}
j.WriteArrayEnd()
more.Up()
{{- end }}

{{- define "enc_json_generic" -}}
{{- $g := $.Type.GenericOf -}}
{{- $v := $.Type.GenericVariant -}}
{{- if $v.Optional -}}
  if {{ $.Var }}.Set {
  {{- template "enc_json_start" $ }}
  {{ $.Var }}.WriteJSON(j{{ if $g.Format }}, json.Write{{ $g.JSON.Format }}{{ end }})
  }
{{- else -}}
    {{- template "enc_json_start" $ }}
    {{ $.Var }}.WriteJSON(j{{ if $g.Format }}, json.Write{{ $g.JSON.Format }}{{ end }})
{{- end -}}
{{- end }}

{{- define "enc_json_array" -}}
{{- $t := $.Type }}
{{- if eq $t.NilSemantic "invalid" -}}
    {{- template "enc_json_start" $ -}}
    {{- template "enc_json_array_elems" $ -}}
{{- else if eq $t.NilSemantic "optional" -}}
  if {{ $.Var }} != nil {
    {{- template "enc_json_start" $ -}}
    {{- template "enc_json_array_elems" $ -}}
  }
{{- else if eq $t.NilSemantic "null" -}}
  {{- template "enc_json_start" $ }}
  if {{ $.Var }} == nil {
    j.WriteNil()
  } else {
    {{- template "enc_json_array_elems" $ -}}
  }
{{- else -}}
Unexpected nil semantic
{{- end -}}
{{- end }}

{{- define "enc_json_value" -}}
{{- $t := $.Type -}}
{{- if or (eq $t.NilSemantic "invalid") (eq $t.NilSemantic "optional") -}}
  if {{ $.Var }} != nil {
    {{- template "enc_json_start" $ }}
    {{ $.Var }}.WriteJSON(j)
  }
{{- else if eq $t.NilSemantic "null" -}}
  {{- template "enc_json_start" $ }}
  if {{ $.Var }} == nil {
    j.WriteNil()
  } else {
    {{ $.Var }}.WriteJSON(j)
  }
{{- else -}}
  {{- template "enc_json_start" $ }}
  {{ $.Var }}.WriteJSON(j)
{{- end -}}
{{- end }}

{{- define "enc_json" -}}
    {{- $t := $.Type }}
    {{- $j := $t.JSON }}
    {{- if or ($t.IsStruct) ($t.IsEnum) ($t.IsPointer) ($t.IsSum) -}}
        {{- template "enc_json_value" $ }}
    {{- else if $t.GenericOf -}}
        {{- template "enc_json_generic" $ }}
    {{- else if $j.Format -}}
        {{- template "enc_json_start" $ }}
        json.Write{{ $j.Format }}(j, {{ $.Var }})
    {{- else if $j.Write -}}
        {{- template "enc_json_start" $ }}
        j.{{ $j.Write }}({{ $.Var }})
    {{- else if $t.IsArray -}}
        {{- template "enc_json_array" $ }}
    {{- else -}}
        {{- if $.Sub -}}
          _ = {{ $.Var }}
        {{- end -}}
        // Unsupported kind "{{ $t.Kind  }}".
    {{- end }}
{{- end -}}
