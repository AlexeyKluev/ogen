{{ define "schemas_json" }}
{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}

{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $s := $.Schemas }}
{{ if $s.IsStruct }}
// WriteJSON implements json.Marshaler.
func (s {{ $s.Name }}) WriteJSON(j *json.Stream) {
    j.WriteObjectStart()
    more := json.NewMore(j)
    defer more.Reset()
    {{- range $f := $s.JSONFields }}
        {{ template "json_value" field_elem $f }}
    {{- end }}
    j.WriteObjectEnd()
}

// WriteJSONTo writes {{ $s.Name }} json value to io.Writer.
func (s {{ $s.Name }}) WriteJSONTo(w io.Writer) error {
    j := json.GetStream(w)
    defer json.PutStream(j)
    s.WriteJSON(j)
    return j.Flush()
}

// ReadJSONFrom reads {{ $s.Name }} json value from io.Reader.
func (s *{{ $s.Name }}) ReadJSONFrom(r io.Reader) error {
    buf := json.GetBuffer()
    defer json.PutBuffer(buf)

    if _, err := buf.ReadFrom(r); err != nil {
        return err
    }
    i := json.GetIterator()
    i.ResetBytes(buf.Bytes())
    defer json.PutIterator(i)

    return s.ReadJSON(i)
}

// ReadJSON reads {{ $s.Name }} from json stream.
func (s *{{ $s.Name }}) ReadJSON(i *json.Iterator) error {
    i.ReadObjectCB(func(i *json.Iterator, k string) bool {
        switch k {
{{- range $f := $s.JSONFields }}
    case "{{ $f.Tag }}":
    {{- if $f.Type.GenericVariant.Optional }}
        s.{{ $f.Name }}.Reset()
    {{- end }}
    {{- if $f.Type.IsStruct }}
        if err := s.{{ $f.Name }}.ReadJSON(i); err != nil {
            i.ReportError("Field {{ $f.Name }}", err.Error())
            return false
        }
        return true
    {{- else if $f.Type.GenericOf }}
    {{- $g := $f.Type.GenericOf }}
    {{- if $g.FormatCustom }}
        if err := s.{{ $f.Name }}.ReadJSON(i, json.Read{{ $g.JSONHelper }}); err != nil {
            i.ReportError("Field {{ $f.Name }}", err.Error())
            return false
        }
        return true
    {{- else }}
        if err := s.{{ $f.Name }}.ReadJSON(i); err != nil {
            i.ReportError("Field {{ $f.Name }}", err.Error())
            return false
        }
        return true
    {{- end }}
    {{- else if $f.Type.JSONRead }}
        s.{{ $f.Name }} = i.{{ $f.Type.JSONRead }}()
        return i.Error == nil
    {{- else if $f.Type.JSONHelper }}
        v, err := json.Read{{ $f.Type.JSONHelper }}(i)
        if err != nil {
            i.ReportError("Field {{ $f.Name }}", err.Error())
            return false
        }
        s.{{ $f.Name }} = v
        return true
    {{- else }}
        // Unsupported kind "{{ $f.Type.Kind  }}" for field "{{ $f.Name }}".
        i.Skip()
        return true
    {{- end }}
{{- end }}
        default:
            i.Skip()
            return true
        }
    })
    return i.Error
}
{{- else if $s.IsGeneric }}
{{ $g := $s.GenericOf }}
{{ $v := $s.GenericVariant }}
// WriteJSON writes json value of {{ $g.Type }} to json stream.
func (o {{ $s.Name }}) WriteJSON(j *json.Stream{{ if $g.FormatCustom }}, format func(*json.Stream, {{ $g.Type }}){{ end }}) {
{{- if $v.Nullable }}
    if o.Null {
        j.WriteNil()
        return
    }
{{- end }}
{{- if $g.FormatCustom }}
    format(j, o.Value)
{{- else if $g.JSONHelper }}
    json.Write{{ $g.JSONHelper }}(j, o.Value)
{{- else if $g.JSONWrite }}
    j.{{ $g.JSONWrite }}({{ $g.Primitive }}(o.Value))
{{- else if $g.IsStruct }}
    o.Value.WriteJSON(j)
{{- end }}
}

// ReadJSON reads json value of {{ $g.Type }} from json iterator.
func (o *{{ $s.Name }}) ReadJSON(i *json.Iterator{{ if $g.FormatCustom }}, format func(*json.Iterator) ({{ $g.Type }}, error){{ end }}) error {
    switch i.WhatIsNext() {
    case json.{{ $g.JSONType }}:
    {{- if $v.Optional }}
        o.Set = true
    {{- end }}
    {{- if $v.Nullable }}
        o.Null = false
    {{- end }}
    {{- if $g.FormatCustom }}
        v, err := format(i)
        if err != nil {
            return err
        }
        o.Value = v
    {{- else if $g.JSONHelper }}
        v, err := json.Read{{ $g.JSONHelper }}(i)
        if err != nil {
            return err
        }
        o.Value = v
    {{- else if $g.JSONRead }}
        o.Value = {{ $g.Type }}(i.{{ $g.JSONRead }}())
    {{- else if $g.IsStruct }}
        if err := o.Value.ReadJSON(i); err != nil {
            return err
        }
    {{- end }}
        return i.Error
    {{- if $v.Nullable }}
    case json.NilValue:
        var v {{ $g.Type }}
        o.Value = v
        {{- if $v.Optional }}
        o.Set = true
        {{- end }}
        o.Null = true
        i.Skip()
        return i.Error
    {{- end }}
    default:
        return fmt.Errorf("unexpected type %d while reading {{ $s.Name }}", i.WhatIsNext())
    }
    return nil
}
{{- end }}

{{- end }}

{{ end }}

{{ define "json_array" }}
{{- /*gotype: github.com/ogen-go/ogen/internal/ast.Leaf*/ -}}
more.Down()
j.WriteArrayStart()
for _, elem := range {{ $.Var }} {
    {{- template "json_value" array_elem $.Type.Item -}}
}
j.WriteArrayEnd()
more.Up()
{{ end }}

{{ define "json_start" }}
{{- /*gotype: github.com/ogen-go/ogen/internal/ast.Leaf*/ -}}
more.More()
{{- if $.Field }}
j.WriteObjectField("{{ $.Field }}")
{{- end -}}
{{ end }}

{{ define "json_value" }}
    {{- /*gotype: github.com/ogen-go/ogen/internal/ast.Leaf*/ -}}
    {{- if $.Type.IsStruct }}
        {{- template "json_start" $ }}
        {{ $.Var }}.WriteJSON(j)
    {{- else if $.Type.GenericOf -}}
        {{- $g := $.Type.GenericOf -}}
        {{- $v := $.Type.GenericVariant -}}
        {{- if $v.Optional -}}
            if {{ $.Var }}.Set {
                {{- template "json_start" $ }}
                {{ $.Var }}.WriteJSON(j{{ if $g.FormatCustom }}, json.Write{{ $g.JSONHelper }}{{ end }})
            }
        {{- else }}
            {{- template "json_start" $ }}
            {{ $.Var }}.WriteJSON(j{{ if $g.FormatCustom }}, json.Write{{ $g.JSONHelper }}{{ end }})
        {{- end }}
    {{- else if $.Type.JSONHelper }}
        {{ template "json_start" $ }}
        json.Write{{ $.Type.JSONHelper }}(j, {{ $.Var }})
    {{- else if $.Type.JSONWrite }}
        {{ template "json_start" $ }}
        j.{{ $.Type.JSONWrite }}({{ $.Var }})
    {{- else if $.Type.IsArray }}
        {{- if eq $.Type.ArrayVariant "required" -}}
            {{ template "json_start" $ }}
            {{ template "json_array" $ }}
        {{- else if eq $.Type.ArrayVariant "optional" -}}
            if {{ $.Var }} != nil {
                {{ template "json_start" $ }}
                {{ template "json_array" $ }}
            }
        {{- else if eq $.Type.ArrayVariant "nullable" }}
            {{- template "json_start" $ }}
            if {{ $.Var }} == nil {
                j.WriteNil()
            } else {
                {{ template "json_array" $ }}
            }
        {{- end }}
    {{- else }}
        // Unsupported kind "{{ $.Type.Kind  }}" for field "{{ $.Field }}".
    {{- end }}
{{ end }}
