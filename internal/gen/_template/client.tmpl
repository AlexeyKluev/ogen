{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}

{{ define "client" }}
{{ $pkg := $.Package }}
{{ template "header" $ }}

type HTTPClient interface {
    Do(req *http.Request) (*http.Response, error)
}

type Client struct {
    serverURL string
    http      HTTPClient
}

func NewClient(serverURL string) *Client {
    return &Client{
        serverURL: serverURL,
        http: &http.Client{
            Timeout: time.Second * 15,
        },
    }
}

{{ range $m := $.Methods }}
func (c *Client) {{ $m.Name }}(ctx context.Context {{ if $m.RequestBody }}, req {{ $m.RequestType.Type }}{{ end }}{{ if $m.Parameters}}, params {{ $m.Name }}Params {{ end }}) (res {{ $m.ResponseType.Type }}, err error) {
    {{- if $m.RequestBody }}
    body, contentType, err := encode{{ $m.Name }}Request(req)
    if err != nil {
        return res, err
    }
    {{ end }}

    {{- template "params_encode_path_v2" $m }}

    r, err := http.NewRequestWithContext(ctx, "{{ $m.HTTPMethod }}", path, {{ if $m.RequestBody }}bytes.NewReader(body){{ else }}nil{{ end }})
    if err != nil {
        return res, fmt.Errorf("create request: %w", err)
    }

    {{ if $m.RequestBody }}r.Header.Set("Content-Type", contentType){{ end }}

    {{- template "params_encode_query_v2" $m }}
    {{- template "encode_header_params" $m }}
    {{- template "encode_cookie_params" $m }}

    resp, err := c.http.Do(r)
    if err != nil {
        return res, fmt.Errorf("do request: %w", err)
    }
    defer resp.Body.Close()

    result, err := decode{{ $m.Name }}Response(resp)
    if err != nil {
        return res, fmt.Errorf("decode response: %w", err)
    }

    return result, nil
}
{{ end }}
{{ end }}


{{ define "encode_cookie_params" }}
{{- range $param := $.CookieParams }}{{/* Range over params */}}
{
value := {{ template "convert_to_string" $param.Schema.Type }}(params.{{ $param.Name }})
{{- if eq $param.Schema.Kind "array" }}
r.AddCookie(&http.Cookie{
    Name: "{{ $param.SourceName }}",
    Value: strings.Join(value, "/"),
    MaxAge: 1337,
})
{{- else }}
r.AddCookie(&http.Cookie{
    Name: "{{ $param.SourceName }}",
    Value: value,
    MaxAge: 1337,
})
{{- end }}
}
{{- end }}{{/* Range over params */}}
{{ end }}


{{ define "encode_header_params" }}
{{- range $param := $.HeaderParams }}{{/* Range over params */}}
{
value := {{ template "convert_to_string" $param.Schema.Type }}(params.{{ $param.Name }})
{{- if eq $param.Schema.Kind "array" }}
for _, v := range value {
    r.Header.Add("{{ $param.SourceName }}", v)
}
{{- else }}
r.Header.Set("{{ $param.SourceName }}", value)
{{- end }}
}
{{- end }}{{/* Range over params */}}
{{ end }}

