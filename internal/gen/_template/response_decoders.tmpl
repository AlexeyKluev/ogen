{{- /*gotype: github.com/ogen-go/ogen/internal/gen.TemplateConfig*/ -}}

{{ define "response_decoders" }}
{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $m := $.Methods }}{{/* Range over all methods */}}

func decode{{ $m.Name }}Response(resp *http.Response) (_ {{ $m.ResponseType }}, rerr error) {
    switch resp.StatusCode {
    {{- range $statusCode, $response := $m.Responses.StatusCode }}{{/* Range over responses */}}
    case {{ $statusCode }}:
        {{- if $response.NoContent }}{{/* Decode NoContent response */}}
        return &{{ $response.NoContent.Name }}{}, nil
        {{- else }}{{/* Decode content response */}}
        switch resp.Header.Get("Content-Type") {
        {{- range $ctype, $schema := $response.Contents }}{{/* Range over contents */}}
        case "{{ $ctype }}":
            {{- if eq $ctype "application/json" }}{{/* Decode */}}
            var response {{ $schema.Type }}
            data, err := io.ReadAll(resp.Body)
            if err != nil {
                rerr = err
                return
            }
            if err := json.Unmarshal(data, &response); err != nil {
                rerr = err
                return
            }

            return &response, nil
            {{- else }}
            rerr = fmt.Errorf("{{ $ctype }} decoder not implemented")
            return
            {{- end }}{{/* Decode */}}
        {{- end }}{{/* Range over contents */}}
        default:
            rerr = fmt.Errorf("unexpected content-type: %s", resp.Header.Get("Content-Type"))
            return
        }
        {{- end }}{{/* Decode content response */}}
    {{- end }}{{/* Range over responses */}}
    default:
        {{- $def := $m.Responses.Default }}
        {{- if $def }}{{/* Decode default response */}}
        {{- if $def.NoContent }}{{/* Decode NoContent response */}}
        return &{{ $def.NoContent.Name }}{StatusCode: resp.StatusCode}, nil
        {{- else }}{{/* Decode content response */}}
        switch resp.Header.Get("Content-Type") {
        {{- range $ctype, $schema := $def.Contents }}{{/* Range over contents */}}
        case "{{ $ctype }}":
            {{- if eq $ctype "application/json" }}{{/* Decode */}}
            var response {{ $schema.Type }}
            data, err := io.ReadAll(resp.Body)
            if err != nil {
                rerr = err
                return
            }
            if err := json.Unmarshal(data, &response.Response); err != nil {
                rerr = err
                return
            }

            response.StatusCode = resp.StatusCode
            return &response, nil
            {{- else }}
            rerr = fmt.Errorf("{{ $ctype }} decoder not implemented")
            return
            {{- end }}{{/* Decode */}}
        {{- end }}{{/* Range over contents */}}
        default:
            rerr = fmt.Errorf("unexpected content-type: %s", resp.Header.Get("Content-Type"))
            return
        }
        {{- end }}{{/* Decode content response */}}
        {{- else }}
        rerr = fmt.Errorf("unexpected statusCode: %d", resp.StatusCode)
        return
        {{- end }}{{- /* Decode default response */}}
    }
}

{{- end }}{{/* Range over all methods */}}
{{ end }}
