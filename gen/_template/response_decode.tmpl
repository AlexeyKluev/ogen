{{ define "response_decoders" }}
{{- /*gotype: github.com/ogen-go/ogen/gen.TemplateConfig*/ -}}
{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $op := $.Operations }}
func decode{{ $op.Name }}Response(resp *http.Response, span trace.Span) (res {{ $op.Responses.Type.Go }}, err error) {
	switch resp.StatusCode {
	{{- range $statusCode, $response := $op.Responses.StatusCode }}{{/* Range over responses */}}
	case {{ $statusCode }}:
		{{- template "decode_response" status_res_elem $response $op.Responses.Type.IsInterface }}
	{{- end }}
	default:
	{{- if $op.Responses.Default }}
		{{- template "decode_response" status_res_elem $op.Responses.Default $op.Responses.Type.IsInterface }}
	{{- else if $.Error }}
		defRes, err := func() (res {{ $.ErrorType.Go }}, err error) {
			{{- template "decode_response" status_res_elem $.Error false }}
		}()
		if err != nil {
			return res, errors.Wrap(err, "default")
		}
		return res, errors.Wrap(&defRes, "error")
	{{- else }}
		return res, validate.UnexpectedStatusCode(resp.StatusCode)
	{{- end }}
	}
}
{{- end }}
{{ end }}

{{- define "decode_response" }}
{{- /*gotype: github.com/ogen-go/ogen/gen.ResponseElem*/ -}}
{{- $response := $.Response }}
{{- $ptr := $.Ptr }}
{{- if $response.NoContent }}{{/* Decode NoContent response */}}
	{{- if $response.Wrapped }}
		return {{ if $ptr }}&{{ end }}{{ $response.NoContent.Name }}{
			StatusCode: resp.StatusCode,
		}, nil
	{{- else }}
		return {{ if $ptr }}&{{ end }}{{ $response.NoContent.Name }}{}, nil
	{{- end }}
{{- else }}{{/* Decode content response */}}
	switch ct := resp.Header.Get("Content-Type"); ct {
	{{- range $contentType, $type := $response.Contents }}{{/* Range over contents */}}
	case {{ quote $contentType }}:
		{{- if $contentType.JSON }}
			{{- if $response.Wrapped }}
				{{- template "decode_response_json" ($type.MustField "Response").Type }}
				return {{ if $ptr }}&{{ end }}{{ $type.Go }}{
					StatusCode: resp.StatusCode,
					Response:   response,
				}, nil
			{{- else }}
				{{- template "decode_response_json" $type }}
				return {{ if $ptr }}&{{ end }}response, nil
			{{- end }}
		{{- else if $type.IsStream }}
			b, err := io.ReadAll(resp.Body)
			if err != nil {
				return res, err
			}

			return {{ if $ptr }}&{{ end }}{{ $type.Name }}{
				Data: bytes.NewReader(b),
			}, nil
		{{- else if $response.Wrapped }}
			b, err := io.ReadAll(resp.Body)
			if err != nil {
				return res, err
			}

			{{- $subTyp := ($type.MustField "Response").Type }}
			{{- if $subTyp.IsStream }}
			return {{ if $ptr }}&{{ end }}{{ $type.Name }}{
				StatusCode: resp.StatusCode,
				Response:   {{ $subTyp.Name }}{
					Data: bytes.NewReader(b),
				},
			}, nil
            {{- else }}
                {{- errorf "%q: %s decoder not implemented" $contentType $type }}
            {{- end }}
		{{- else }}
            {{- errorf "%q: %s decoder not implemented" $contentType $type }}
		{{- end }}
	{{- end }}{{/* Range over contents */}}
	default:
		return res, validate.InvalidContentType(ct)
	}
{{- end }}{{/* Decode content response */}}
{{- end }}

{{ define "decode_response_json" }}
{{- /*gotype: github.com/ogen-go/ogen/gen/ir.Type*/ -}}
buf := getBuf()
defer putBuf(buf)
if _, err := io.Copy(buf, resp.Body); err != nil {
	return res, err
}

d := jx.GetDecoder()
defer jx.PutDecoder(d)
d.ResetBytes(buf.Bytes())

var response {{ $.Go }}
if err := func() error {
	{{- template "json/dec" req_elem $ }}
	return nil
}(); err != nil {
	return res, err
}
{{ end }}
